# Business Rules of The Hrönir Encyclopedia

This table defines the fundamental rules, principles, and constraints that govern The Hrönir Encyclopedia. These rules are the "laws of physics" for this narrative universe, ensuring its integrity, coherence, and ability to evolve. All participants, whether human contributors or automated agents, must operate within this framework.

### Content & Storage (The Hrönirs)

| ID   | Rule Name                  | Description                                                                                                                                                                                 |
| :--- | :------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| CS.1 | Hrönir Immutability & UUID | The canonical identifier for a hrön is a version 5 UUID, deterministically generated from the full, exact text content of its `index.md` file. Hrönirs are immutable.                       |
| CS.2 | Canonical File Path        | Each hrön is stored in a unique directory path derived from its UUID. The path is constructed by using each character of the UUID as a subdirectory name (e.g., `the_library/d/9/4/4/...`). |
| CS.3 | Required Folder Contents   | Each hrön directory **must** contain an `index.md` file with the chapter's text and a `metadata.json` file.                                                                                 |
| CS.4 | Metadata Integrity         | The `metadata.json` file **must** contain a `uuid` field that exactly matches the content-derived UUID of the `index.md` file. It may also contain a `previous_uuid`.                       |
| CS.5 | Hrönir Validity Conditions | A hrön is only valid if it exists at its correct UUID-derived path and its `metadata.json` `uuid` matches its content-derived UUID. Invalid hrönir are subject to automated purging.        |

### Narrative Structure (The Narrative Paths)

| ID   | Rule Name               | Description                                                                                                                                                                                       |
| :--- | :---------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| NS.1 | Path Definition         | Narrative paths are defined in `.csv` files within the `narrative_paths/` directory. Each row represents a single path and **must** contain `position`, `prev_uuid`, and `uuid`.                  |
| NS.2 | Path UUID Generation    | Each narrative path row **must** have a `path_uuid` field, which is a version 5 UUID deterministically generated from the combined string of `position:prev_uuid:uuid`.                           |
| NS.3 | Narrative Path Validity | A narrative path entry is only valid if its `path_uuid` is correct and both its `prev_uuid` and `uuid` fields point to existing, valid hrönirs. Invalid entries are subject to automated purging. |

### Selection & Canonization (Voting)

| ID        | Rule Name                                           | Description                                                                                                                                                                                                                                                                                                                                                                                          |
| :-------- | :-------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| SC.0      | Canonical Lineage Restriction                       | Competition for Position `N` (i.e., paths that can be voted upon for position `N`) is restricted to paths whose `prev_uuid` matches the `hrönir_uuid` of the `QUALIFIED` and `is_canonical` path at Position `N-1`. This is enforced when generating duel information via `query get-duel`.                                                                                                |
| SC.1      | Proof-of-Work & Relevance for Voting Mandate        | Creating a new path and having it achieve `QUALIFIED` status (by demonstrating relevance through duel performance against peers at its own position) grants a "voting mandate". This mandate is tied to the `path_uuid` of the qualified path.                                                                                                                                               |
| SC.2      | Vote Structure and Submission                       | Votes are submitted as structured data (JSON, matching the `SessionVerdict` model structure) via the `hronir vote submit` command. Each vote **must** specify `position`, `winner_hrönir_uuid`, `loser_hrönir_uuid`, and `predecessor_hrönir_uuid` (which is `null` for votes on position 0). Submitted votes directly update Elo ratings in DuckDB.                                                              |
| SC.3      | Mandate Identity for Voting                         | Votes submitted via `hronir vote submit` **must** be authorized by a valid `mandate_path_uuid` (the `path_uuid` of a `QUALIFIED` path). This `mandate_path_uuid` acts as the voter identity for that batch of votes and is recorded in the transaction.                                                                                                                                        |
| SC.4      | Voting Allowance per Mandate                        | A single voting mandate, granted by a path at Position `N` becoming `QUALIFIED`, allows the agent to submit a batch of up to `sqrt(N)` votes. These votes can be for duels at any prior positions (i.e., positions `< N`). The agent chooses which positions to vote on within this allowance.                                                                                                  |
| SC.5      | Vote Validity Conditions                            | A submitted vote is valid if: its specified `mandate_path_uuid` corresponds to a path that is currently `QUALIFIED`; the total number of votes in the submission batch does not exceed the `sqrt(N)` allowance for the mandate path; each vote's `winner_hrönir_uuid` and `loser_hrönir_uuid` correspond to valid paths at the specified vote `position` that could form a legitimate duel in that context. |
| **SC.6**  | **Temporal Cascade for Canonization**               | The canonical path (represented by `is_canonical` flags on paths in DuckDB) is determined by the "Temporal Cascade" process. This cascade is triggered **exclusively** by a `hronir vote submit` transaction. It recalculates the canon by determining the highest-rated path for each position, starting from the oldest position affected by the submitted votes.                                           |
| **SC.7**  | **Maximal Entropy Duels Discovery**                 | Agents can discover duels using `hronir query get-duel --position <P>`. This command should prioritize presenting duels of maximal entropy (closest Elo scores) among eligible paths for the given position and its canonical predecessor context.                                                                                                                                                  |
| **SC.8**  | **Mandate Consumption**                             | A voting mandate associated with a `QUALIFIED` path is marked as `SPENT` after a `hronir vote submit` command using that `mandate_path_uuid` is successfully processed and its transaction recorded. A `SPENT` mandate cannot be reused for further voting.                                                                                                                                   |
| **SC.11** | **Temporal Cascade as Sole Canon Updater**          | The determination and update of the canonical path (i.e., setting `is_canonical` flags in the database) is **always** a result of the Temporal Cascade, triggered **exclusively** by a `hronir vote submit` transaction. The `hronir admin recover-canon` command also uses this mechanism, initiating a cascade from position 0.                                                                           |
| **SC.12** | **Perenidade do Voto e Influência Dinâmica no Elo** | Votes, once processed via a transaction, permanently affect the Elo ratings of the involved hrönirs/paths. Their ongoing influence on which path is deemed canonical is dynamic, as the Temporal Cascade re-evaluates the canonical path based on the most current aggregate ratings.                                                                                                                  |
| **SC.13** | **Qualificação por Mérito (Anti-Sybil)**            | Creating a path is open, but influence (the right to cast votes via a mandate) is earned. A path only provides a voting mandate after it achieves `QUALIFIED` status by proving its relevance in duels against other paths at its own position. This makes it costly to gain significant voting power.                                                                                             |

### System & Ledger

| ID        | Rule Name                            | Description                                                                                                                                                                                             |
| :-------- | :----------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **SYS.1** | **Ledger Cronológico de Transações** | Cada `hronir vote submit` action results in a transaction recorded in the `transactions` table in DuckDB. This forms a chronological, auditable ledger of voting events and their impact on the canon. |

### Generation & Contribution (Agents)

| ID   | Rule Name                      | Description                                                                                                                                                                                                                              |
| :--- | :----------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| GC.1 | Commit All Generated Artifacts | All generated content—including hrönirs, narrative path entries, and votes created for any purpose (testing, PoW, etc.)—**must** be committed to the repository to ensure transparency and reproducibility.                              |
| GC.2 | Agent Compliance               | Automated agents (e.g., GitHub Actions) are bound by the same rules as human contributors.                                                                                                                                               |
| GC.3 | Automated System Cleaning      | The system **must** maintain its own integrity through automated cleaning processes. The `hronir-clean` pre-commit hook is a mandatory process that purges all invalid artifacts to keep the repository in a consistent and valid state. |
